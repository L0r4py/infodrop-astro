#!/usr/bin/env node

/**
 * ğŸ”§ Script de setup automatique pour INFODROP
 * 
 * Ce script configure automatiquement l'environnement de dÃ©veloppement :
 * - VÃ©rifie les prÃ©requis (Node.js, npm)
 * - CrÃ©e le fichier .env avec des valeurs par dÃ©faut
 * - Installe les dÃ©pendances
 * - Affiche les instructions de configuration Supabase
 */

import { execSync } from 'child_process';
import { writeFileSync, existsSync, readFileSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const projectRoot = join(__dirname, '..');

// Couleurs pour la console
const colors = {
    reset: '\x1b[0m',
    bright: '\x1b[1m',
    red: '\x1b[31m',
    green: '\x1b[32m',
    yellow: '\x1b[33m',
    blue: '\x1b[34m',
    magenta: '\x1b[35m',
    cyan: '\x1b[36m',
};

function log(message, color = 'reset') {
    console.log(`${colors[color]}${message}${colors.reset}`);
}

function step(number, message) {
    log(`\n${number}. ${message}`, 'bright');
}

function success(message) {
    log(`âœ… ${message}`, 'green');
}

function warning(message) {
    log(`âš ï¸  ${message}`, 'yellow');
}

function error(message) {
    log(`âŒ ${message}`, 'red');
}

function info(message) {
    log(`â„¹ï¸  ${message}`, 'blue');
}

async function checkPrerequisites() {
    step(1, 'VÃ©rification des prÃ©requis');

    try {
        // VÃ©rifier Node.js
        const nodeVersion = execSync('node --version', { encoding: 'utf8' }).trim();
        const majorVersion = parseInt(nodeVersion.replace('v', '').split('.')[0]);

        if (majorVersion >= 20) {
            success(`Node.js ${nodeVersion} âœ“`);
        } else {
            error(`Node.js ${nodeVersion} dÃ©tectÃ©. Version 20+ requise.`);
            process.exit(1);
        }

        // VÃ©rifier npm
        const npmVersion = execSync('npm --version', { encoding: 'utf8' }).trim();
        success(`npm ${npmVersion} âœ“`);

    } catch (err) {
        error('Node.js ou npm non trouvÃ©. Veuillez les installer d\'abord.');
        info('TÃ©lÃ©chargez Node.js sur : https://nodejs.org/');
        process.exit(1);
    }
}

function createEnvFile() {
    step(2, 'Configuration du fichier .env');

    const envPath = join(projectRoot, '.env');

    if (existsSync(envPath)) {
        warning('Le fichier .env existe dÃ©jÃ . Sauvegarde en .env.backup');
        const backup = readFileSync(envPath, 'utf8');
        writeFileSync(join(projectRoot, '.env.backup'), backup);
    }

    const envTemplate = `# ================================================================
# ğŸ” CONFIGURATION INFODROP v4.0.0-beta
# ================================================================

# === SUPABASE (OBLIGATOIRE) ===
# RÃ©cupÃ©rez ces valeurs depuis votre dashboard Supabase
SUPABASE_URL=https://votre-projet.supabase.co
SUPABASE_ANON_KEY=votre_clÃ©_publique_supabase
SUPABASE_SERVICE_KEY=votre_clÃ©_service_supabase

# === ADMINISTRATION ===
# Emails des administrateurs (sÃ©parÃ©s par des virgules)
ADMIN_EMAILS=admin@example.com

# === PAIEMENTS (OPTIONNEL) ===
# Lien Stripe pour les dons
STRIPE_LINK=https://buy.stripe.com/votre_lien_stripe

# === CRON JOBS (OPTIONNEL) ===
# Secret pour sÃ©curiser les scripts automatisÃ©s
CRON_SECRET=\${Date.now()}-\${Math.random().toString(36).substring(2)}

# ================================================================
# ğŸ“ INSTRUCTIONS :
# 1. Remplacez les valeurs par vos vraies clÃ©s Supabase
# 2. Modifiez ADMIN_EMAILS avec votre email
# 3. Sauvegardez ce fichier
# 4. Lancez : npm run dev
# ================================================================
`;

    writeFileSync(envPath, envTemplate);
    success('Fichier .env crÃ©Ã© avec des valeurs par dÃ©faut');
    warning('âš ï¸  IMPORTANT : Modifiez le fichier .env avec vos vraies clÃ©s !');
}

function installDependencies() {
    step(3, 'Installation des dÃ©pendances');

    try {
        info('Installation en cours... (cela peut prendre quelques minutes)');
        execSync('npm install', {
            stdio: 'pipe',
            cwd: projectRoot
        });
        success('DÃ©pendances installÃ©es avec succÃ¨s');
    } catch (err) {
        error('Erreur lors de l\'installation des dÃ©pendances');
        console.log(err.stdout?.toString());
        console.error(err.stderr?.toString());
        process.exit(1);
    }
}

function showSupabaseInstructions() {
    step(4, 'Configuration Supabase requise');

    log('\nğŸ“‹ Ã‰TAPES Ã€ SUIVRE DANS SUPABASE :', 'cyan');
    log('');
    log('1. CrÃ©ez un nouveau projet sur https://supabase.com', 'bright');
    log('2. RÃ©cupÃ©rez l\'URL du projet et la clÃ© publique dans Settings > API');
    log('3. CrÃ©ez une clÃ© de service dans Settings > API > Service Role');
    log('4. ExÃ©cutez les requÃªtes SQL suivantes dans l\'Ã©diteur SQL :');
    log('');
    log('   -- Table des actualitÃ©s', 'yellow');
    log('   CREATE TABLE actu (', 'yellow');
    log('     id BIGSERIAL PRIMARY KEY,', 'yellow');
    log('     resume TEXT NOT NULL,', 'yellow');
    log('     url TEXT UNIQUE NOT NULL,', 'yellow');
    log('     heure TIMESTAMPTZ DEFAULT NOW(),', 'yellow');
    log('     source TEXT NOT NULL,', 'yellow');
    log('     orientation TEXT,', 'yellow');
    log('     tags TEXT[],', 'yellow');
    log('     added_by TEXT', 'yellow');
    log('   );', 'yellow');
    log('');
    log('   -- Table des codes d\'invitation', 'yellow');
    log('   CREATE TABLE invitation_codes (', 'yellow');
    log('     id BIGSERIAL PRIMARY KEY,', 'yellow');
    log('     code TEXT UNIQUE NOT NULL,', 'yellow');
    log('     owner_email TEXT,', 'yellow');
    log('     used_by_email TEXT,', 'yellow');
    log('     is_used BOOLEAN DEFAULT FALSE,', 'yellow');
    log('     created_at TIMESTAMPTZ DEFAULT NOW()', 'yellow');
    log('   );', 'yellow');
    log('');
    log('5. Activez Row Level Security et configurez les politiques');
    log('6. Configurez l\'authentification (Magic Links)');
    log('');
    info('ğŸ“– Instructions complÃ¨tes dans README.md');
}

function showNextSteps() {
    step(5, 'Prochaines Ã©tapes');

    log('\nğŸš€ VOTRE PROJET EST PRÃŠT !', 'green');
    log('');
    log('Pour continuer :', 'bright');
    log('1. Ã‰ditez le fichier .env avec vos clÃ©s Supabase', 'cyan');
    log('2. Configurez votre base de donnÃ©es Supabase (voir instructions ci-dessus)', 'cyan');
    log('3. Lancez le serveur de dÃ©veloppement :', 'cyan');
    log('   npm run dev', 'yellow');
    log('');
    log('4. Ouvrez http://localhost:4321 dans votre navigateur', 'cyan');
    log('');
    log('ğŸ“š Documentation complÃ¨te : README.md', 'blue');
    log('ğŸ› Support : https://github.com/votre-org/infodrop-astro/issues', 'blue');
    log('ğŸ¦ Twitter : @LOR4_14', 'blue');
    log('');
    success('Setup terminÃ© ! Bon dÃ©veloppement ! ğŸ‰');
}

async function main() {
    log('ğŸ”§ INFODROP v4.0.0-beta - Script de setup automatique', 'magenta');
    log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'magenta');

    try {
        await checkPrerequisites();
        createEnvFile();
        installDependencies();
        showSupabaseInstructions();
        showNextSteps();
    } catch (err) {
        error('Erreur durant le setup :');
        console.error(err);
        process.exit(1);
    }
}

// Lancer le script
main().catch(console.error);